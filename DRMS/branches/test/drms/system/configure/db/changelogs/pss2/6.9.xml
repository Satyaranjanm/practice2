<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
    http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

    <!-- NOTE !!!! -->
    <!-- If this file is moved, the attribute 'logicalFilePath' *MUST* be 
        added to the databaseChangeLog tag with a value equal to the previous relative 
        path of this file from drms/system/configure. For example, if this file was 
        in trunk/drms/system/configure/db/changelogs/pss2/changelogs.xml and was 
        moved to trunk/drms/system/configure/database/pss2/chnagelogs.xml, the attribute 
        logicalFilePath="db/changelogs/pss2/changelogs.xml" must be set or else the 
        changesets within this file will be re-applied to existing databases. This 
        could result in undesired behavior. See DRMS-5553 for more info. -->
    <!-- !!!! -->

    <!-- See http://liquibase.org/manual/home for documentation -->

    <changeSet id="1" author="Veera">
        <comment>DRMS-4438 Core Property feature.reportClientNonParticipation typo update</comment>
        <update tableName="core_property">
            <column name="propertyName" value="feature.reportClientNonParticipation" />
            <where>propertyName='feature.reportClinetNonParticipation'</where>
        </update>
    </changeSet>

    <changeSet id="2" author="Veera">
        <comment>DRMS-4438 Change the log-in text for SCE</comment>
        <modifyDataType tableName="core_property" columnName="stringValue" newDataType="varchar(5000)"/>
    </changeSet>
 
	<changeSet id="5" author="liu">
        <comment>DRMS-4618 CBP Signals Sent to Aggregators</comment>
        <addColumn tableName="participant">
            <column name="cbpAggregator" type="BIT" />
        </addColumn>
    </changeSet> 
			
    <changeSet id="6" author="Frank">
        <comment>DRMS-4926 Merge Usage Data CLONES from 6.2.5 to Trunk</comment>
        <sql>
			UPDATE baseline_config SET excludeHoliday=1;
		</sql>
    </changeSet>
    <changeSet id="7" author="Linda">
        <comment>DRMS-4619 DBP Event Dispatch via FTP</comment>
        <sql>
			DROP TABLE IF EXISTS `scedbp_dispatch_config`;
			CREATE TABLE `scedbp_dispatch_config` (
			  `uuid` varchar(32) NOT NULL,
			  `host` varchar(30) DEFAULT NULL,
			  `port` int(11) DEFAULT NULL,
			  `username` varchar(255) DEFAULT NULL,
			  `password` varchar(100) DEFAULT NULL,
			  `backupPath` varchar(255) DEFAULT NULL,
			  `filenameTemplate` varchar(255) DEFAULT NULL,
			  `scanStartTime` varchar(10) DEFAULT NULL,
			  `scanEndTime` varchar(10) DEFAULT NULL,
			  `scanInterval` int(11) DEFAULT NULL,
			  `required` bit DEFAULT b'0',
			  `creationTime` datetime DEFAULT NULL,
			  PRIMARY KEY (`uuid`)
			) ENGINE=MyISAM DEFAULT CHARSET=latin1;
		</sql>
    </changeSet>
	
    <changeSet id="8" author="Linda">
        <comment>DRMS-5029 Operator Report API development</comment>
        <addColumn tableName="history_event_participant">
            <column name="offlinePerEvent" type="double">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>
	
    <changeSet id="9" author="Linda">
        <comment>DRMS-5029 Operator Report API development</comment>
        <addColumn tableName="client_status">
            <column name="clientName" type="varchar(64)">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>

	    <changeSet id="10" author="Linda">
        <comment>DRMS-5029 Operator Report API development</comment>
        <addColumn tableName="history_event_participant_signal">
            <column name="signalEndTime" type="datetime">
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>
    
    	
    <changeSet id="11" author="Veera">
        <comment>DRMS-3315 Inherit default message threshold</comment>
        <addColumn tableName="contact">
            <column name="defaultMsgThreshold" type="boolean"
            	defaultValueBoolean="true">
            	<constraints nullable="true" />
            </column>
        </addColumn>
        <update tableName="contact">
            <column name="defaultMsgThreshold" valueBoolean="true" />
        </update>        	        
    </changeSet>
    	
    <changeSet id="12" author="Veera">
        <comment>DRMS-3315 Define default message threshold</comment>
        <addColumn tableName="contact">
            <column name="msgThreshold" type="bigint"
            	defaultValue="0">
            	<constraints nullable="true" />
            </column>
        </addColumn>
        <update tableName="contact">
            <column name="msgThreshold" value="0" />
        </update>        	
    </changeSet>

    	
    <changeSet id="13" author="Veera">
        <comment>DRMS-3315 Inherit default message threshold</comment>
        <addColumn tableName="participant_contact">
            <column name="defaultMsgThreshold" type="boolean"
            	defaultValueBoolean="true">
            	<constraints nullable="true" />
            </column>
        </addColumn>
        <update tableName="participant_contact">
            <column name="defaultMsgThreshold" valueBoolean="true" />
        </update>        	
    </changeSet>
    
    	
    <changeSet id="14" author="Veera">
        <comment>DRMS-3315 Redefine default message threshold</comment>
        <dropDefaultValue tableName="participant_contact" columnName="msgThreshold"/>
        <addDefaultValue tableName="participant_contact"
        	columnName="msgThreshold" defaultValue="0" />
        <update tableName="participant_contact">
            <column name="msgThreshold" value="0" />
            <where>msgThreshold=10</where>
        </update>        	
    </changeSet>

    <changeSet id="15" author="Veera">
        <comment>DRMS-3315 Update default message threshold setting</comment>
        <update tableName="message_filter_setting">
            <column name="msgThreshold" value="10" />
        </update>        	
    </changeSet>
    
	<changeSet id="15" author="Daoping">
		 <comment>DRMS-5027 database view:all_program_participant for Reporting</comment>
		 <sql>
			CREATE OR REPLACE VIEW all_program_participant AS 
			SELECT pp.uuid, p.participantName,p.client, pp.participant_uuid,pp.programName,pp.parent_uuid, pp.program_uuid, 
				IF(pp.ancestry IS NULL,pp.uuid,pp.ancestry) AS ancestry 
			FROM program_participant pp, participant p 
			WHERE pp.participant_uuid = p.uuid AND p.client=FALSE
			
			UNION  ALL
			
			SELECT REPLACE(uuid(), '-', '') AS UUID, p1.participantName, TRUE AS CLIENT,
				p1.uuid AS participant_uuid,pp1.programName,pp2.uuid AS parent_uuid, pp1.program_uuid,
				IF(pp2.ancestry IS NULL,pp2.uuid,CONCAT(pp2.ancestry,pp2.uuid)) AS ancestry
			FROM participant p1, participant p2,program_participant pp1, program_participant pp2
			WHERE 
				p1.parent = p2.participantName AND 
				pp1.state=1 AND  pp1.parent_uuid IS NULL AND p1.uuid = pp1.participant_uuid 
				AND p2.uuid = pp2.participant_uuid AND pp1.programName = pp2.programName 
		</sql>
	</changeSet>
	

	 <changeSet author="liu" id="16">
		 <comment>DRMS-5223 [SCE] change "CBP Aggregator" to Aggregator</comment>
        <renameColumn tableName="participant"
            newColumnName="aggregator" oldColumnName="cbpAggregator"
            columnDataType="BIT"  />
    </changeSet>
    
    <changeSet id="17" author="veera">
		 <comment>DRMS-5247</comment>
        <update tableName="program">
            <column name="mustIssueBDBE" valueBoolean="false"  />
            <where>name like 'RTP%'</where>
        </update>
    </changeSet>
    
	<changeSet id="18" author="liu">
        <comment>
           DRMS-5210 DR-Website - Event History search dialog - DRC missing from Program list
        </comment>
        <delete tableName="core_property">
            <where>propertyName='drwebsite.enabledDRC'</where>
        </delete>
    </changeSet>
    
	<changeSet id="19" author="Veera">
        <comment>
           DRMS-5221 SuppressAllEmails flag
        </comment>
        <delete tableName="core_property">
            <where>propertyName='SuppressAllEmails'</where>
        </delete>
        <sql>insert into core_property(uuid, version, propertyName, stringValue, booleanValue, doubleValue, textValue, type, creator, modifier, creationTime, modifiedTime) values (REPLACE(uuid(), '-', ''), 0, 'SuppressAllEmails', null, true, null, null, 'Boolean', 'script', null, now(), null);</sql>
	</changeSet>
	
	<changeSet id="20" author="Chris">
        <comment>DRMS-5266 JACE polling causes participant's client opt-out when event is issued</comment>
        <addColumn tableName="participant">
            <column name="clientAllowedToOptOut" type="tinyint(1)"
                defaultValueBoolean="false">
                <constraints nullable="false" />
            </column>
        </addColumn>
        <update tableName="participant">
            <column name="clientAllowedToOptOut" valueBoolean="false" />
        </update>           
    </changeSet>
    
    <changeSet id="22" author="brian">
        <preConditions onFail="CONTINUE">
            <tableExists tableName="db_version" />
        </preConditions>
        <comment>DRMS-4689</comment>
        <dropTable tableName="db_version" />
    </changeSet>
	
	<changeSet id="23" author="Linda">
        <comment>
           DRMS-4619 remove sce dbp configuration from core property
        </comment>
        <delete tableName="core_property">
            <where>propertyName like 'scedbp.event.%'</where>
        </delete>
    </changeSet>
	
	<changeSet id="24" author="Linda">
        <comment>DRMS-4619 add upload flag</comment>
        <addColumn tableName="scedbp_dispatch_config">
            <column name="upload" type="bit"
                defaultValueBoolean="0">
                <constraints nullable="false" />
            </column>
            <column name="fixedFilename" type="varchar(255)">
                <constraints nullable="true" />
            </column>
        </addColumn>
		<renameColumn tableName="scedbp_dispatch_config"
            newColumnName="formattedFilename" oldColumnName="filenameTemplate"
            columnDataType="varchar(255)"/>
    </changeSet>

</databaseChangeLog>
