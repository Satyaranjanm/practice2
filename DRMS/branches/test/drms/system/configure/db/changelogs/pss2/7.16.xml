<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
    http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">

    <!-- NOTE !!!! -->
    <!-- If this file is moved, the attribute 'logicalFilePath' *MUST* be 
        added to the databaseChangeLog tag with a value equal to the previous relative 
        path of this file from drms/system/configure. For example, if this file was 
        in trunk/drms/system/configure/db/changelogs/pss2/changelogs.xml and was 
        moved to trunk/drms/system/configure/database/pss2/chnagelogs.xml, the attribute 
        logicalFilePath="db/changelogs/pss2/changelogs.xml" must be set or else the 
        changesets within this file will be re-applied to existing databases. This 
        could result in undesired behavior. See DRMS-5553 for more info. -->
    <!-- !!!! -->
    <!-- See http://liquibase.org/manual/home for documentation -->	
	
	<changeSet id="1" author="Liu">
        <comment>
               DRMS-8077 Client test email contact configuration
        </comment>
		<sql>	
				ALTER TABLE contact ADD COLUMN digestEnable BIT(1) DEFAULT 0;
				
				ALTER TABLE contact ADD COLUMN digestInterval int(11) DEFAULT 0;
				
				create table if not exists `timer_config`(`UUID` varchar(32) not null , `creationTime` datetime ,`timerEnable` tinyint(1),
				`name` varchar(64) ,`type` varchar(64) , `invokeHour` int(10) ,  `invokeMin` int(10) ,`invokeSec` int(10) , `interval` double , 
				`startYear` int(10) ,  `startMonth` int(10) ,`startDay` int(10) ,`endYear` int(10) ,  `endMonth` int(10) ,`endDay` int(10) ,
				  primary key (`UUID`) );	

								
				 insert into `timer_config` (`UUID`, `creationTime`, `timerEnable`, `name`,`type`, `invokeHour`, `invokeMin`, `invokeSec`, `interval`,`startMonth`, `startDay`, `endMonth`, `endDay`,`startYear`,`endYear`) 
				 values(REPLACE(UUID(), '-', ''),NOW(),'0','CLIENT_OFFLINE_REPORT_TIMER','NORMAL','0','30','0','86400000','0','0','0','0','0','0');               
				  insert into `timer_config` (`UUID`, `creationTime`, `timerEnable`, `name`,`type`, `invokeHour`, `invokeMin`, `invokeSec`, `interval`,`startMonth`, `startDay`, `endMonth`, `endDay`,`startYear`,`endYear`) 
				 values(REPLACE(UUID(), '-', ''),NOW(),'0','CLIENT_OFFLINE_NOTIFICATION_EMAIL_DAILY_TIMER','CONTINUE_SCOPE','0','30','0','86400000','5','1','8','30','0','0'); 
				  insert into `timer_config` (`UUID`, `creationTime`, `timerEnable`, `name`,`type`, `invokeHour`, `invokeMin`, `invokeSec`, `interval`,`startMonth`, `startDay`, `endMonth`, `endDay`,`startYear`,`endYear`) 
				 values(REPLACE(UUID(), '-', ''),NOW(),'0','CLIENT_OFFLINE_NOTIFICATION_EMAIL_WEEKLY_TIMER','CONTINUE_SCOPE','0','30','0','604800000','9','1','4','30','0','0');     				
		</sql>
    </changeSet>
	<changeSet id="2" author="Liu">
        <comment>
               DRMS-7956  Client Offline Notification Email
        </comment>
		<sql>	
				CREATE TABLE `report_client_offline` (
					`uuid` varchar(32) NOT NULL,
					`creationTime` datetime DEFAULT NULL,
					`generateTime` datetime DEFAULT NULL,
					`reportName` varchar(255) DEFAULT NULL,
					`comments` varchar(255) DEFAULT NULL,
					PRIMARY KEY (`uuid`)
				); 
				CREATE TABLE `report_client_offline_entity` (
				  `uuid` varchar(32) NOT NULL,
				  `report_uuid` varchar(32) NOT NULL,
				  `clientName` varchar(25) DEFAULT NULL,
				  `participantName` varchar(255) DEFAULT NULL,
				  `accountNumber` varchar(255) DEFAULT NULL,
				  `lastContact` datetime DEFAULT NULL,
				  `offline` varchar(255) DEFAULT NULL,
				  `generateTime` datetime DEFAULT NULL,
				  `creationTime` datetime DEFAULT NULL,
				  `startTime` datetime DEFAULT NULL,
				  `endTime` datetime DEFAULT NULL,
				  PRIMARY KEY (`uuid`)
				);
				
				insert into core_property(uuid, version, propertyName,
				stringValue, booleanValue, doubleValue, textValue, type,
				creator, modifier, creationTime, modifiedTime) values
				(REPLACE(uuid(), '-', ''), 0, 'feature.clientOfflineNotificationEnable',
				null, false, null, null, 'Boolean', 'script', null, now(),
				null);
				insert into core_property(uuid, version, propertyName,
				stringValue, booleanValue, doubleValue, textValue, type,
				creator, modifier, creationTime, modifiedTime) values
				(REPLACE(uuid(), '-', ''), 0, 'feature.timerConfigEnable',
				null, false, null, null, 'Boolean', 'script', null, now(),
				null);
				insert into core_property(uuid, version, propertyName,
				stringValue, booleanValue, doubleValue, textValue, type,
				creator, modifier, creationTime, modifiedTime) values
				(REPLACE(uuid(), '-', ''), 0, 'feature.clientOfflineNotificationficicationSummerThreshold',
				null, null, 24, null, 'Number', 'script', null, now(),
				null);
				insert into core_property(uuid, version, propertyName,
				stringValue, booleanValue, doubleValue, textValue, type,
				creator, modifier, creationTime, modifiedTime) values
				(REPLACE(uuid(), '-', ''), 0, 'feature.clientOfflineNoficicationUnSummerThreshold',
				null, null, 168, null, 'Number', 'script', null, now(),
				null);
				
				ALTER TABLE participant ADD COLUMN optOutClientOfflineNotification BIT(1) DEFAULT 0;
				ALTER TABLE participant ADD COLUMN clientOfflineNotificationEnable BIT(1) DEFAULT 0;
				ALTER TABLE participant ADD COLUMN thresholdsSummer int(11) DEFAULT 24;
				ALTER TABLE participant ADD COLUMN thresholdsUnSummer int(11) DEFAULT 168;
				ALTER TABLE participant ADD COLUMN clientOfflineNotificationAggEnable BIT(1) DEFAULT 0;
				
				insert into core_property(uuid, version, propertyName,
				stringValue, booleanValue, doubleValue, textValue, type,
				creator, modifier, creationTime, modifiedTime) values
				(REPLACE(uuid(), '-', ''), 0, 'feature.clientOfflineReportEnable',
				null, false, null, null, 'Boolean', 'script', null, now(),
				null);
				
				alter table timer_config add column threshold int(11) default 24;
				alter table timer_config add column day int(11) default 0;
				
				update timer_config c set c.invokeHour = '1', c.invokeMin = '0', c.threshold = '168', c.day = '0' where name = 'CLIENT_OFFLINE_NOTIFICATION_EMAIL_WEEKLY_TIMER';
				delete from core_property where propertyName = 'feature.timerConfigEnable';
				delete from core_property where propertyName = 'feature.clientOfflineNoficicationSummerThreshold';
				delete from core_property where propertyName = 'feature.clientOfflineNoficicationUnSummerThreshold';
		</sql>
    </changeSet>
	
	<changeSet id="3" author="Frank">
        <comment>
               	DRMS-7955 : SCE 2013ï¼šReprort to capture undelivered emails
        </comment>
		<sql>	
				insert into core_property(uuid, version, propertyName,
				stringValue, booleanValue, doubleValue, textValue, type,
				creator, modifier, creationTime, modifiedTime) values
				(REPLACE(uuid(), '-', ''), 0, 'feature.enableUndeliveredEmail',
				null, false, null, null, 'Boolean', 'script', null, now(),
				null);
				
				ALTER TABLE `pss2`.`contact` ADD COLUMN `optOutUndeliveredReport` BIT(1) DEFAULT b'0' NULL AFTER `digestInterval`;
				
				INSERT INTO core_property(`uuid`,`version`,`propertyName`,`stringValue`,`booleanValue`,`doubleValue`,`creator`,`modifier`,`creationTime`,`modifiedTime`,`type`,`textValue`) 
				VALUES 
				( REPLACE(UUID(), '-', ''),'0','undelivered.send.timepoint','07:00:00',NULL,NULL,'script',NULL,NOW(),NULL,'String',NULL);
		</sql>
    </changeSet>
	
	<changeSet id="4" author="Liu">
        <comment>
               DRMS-8212  Client Offline Report and Notification
        </comment>
		<sql>	
			   alter table report_client_offline_entity modify column clientName varchar(255) ;
		</sql>
    </changeSet>
	<changeSet id="5" author="Liu">
        <comment>
               DRMS-8225 Client offline notification email: In edit participant page, the threshold of summer and winter has no validation.
        </comment>
		<sql>	
			   delete from core_property where propertyName = 'feature.clientOfflineNotificationficicationSummerThreshold' ;
		</sql>
    </changeSet>
</databaseChangeLog>